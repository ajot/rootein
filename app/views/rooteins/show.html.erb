<div class="max-w-5xl mx-auto mt-6">
  <!-- Add New Rootein link -->
  <div class="text-right mb-4">
    <%= link_to new_rootein_path, class: "text-green-600 hover:text-green-700 font-semibold" do %>
      <span class="text-lg">+</span> Add New Rootein
    <% end %>
  </div>

  <div class="flex gap-8">
    <!-- Sidebar: rootein list -->
    <div class="w-72 shrink-0">
      <div class="rounded-lg overflow-hidden border border-gray-300 bg-white" data-controller="sortable">
        <div class="bg-gray-900 text-white text-center py-2 font-semibold text-sm">My Active Rooteins</div>
        <ul class="divide-y divide-gray-200">
          <% @rooteins.each do |rootein| %>
            <li class="group <%= rootein == @rootein ? 'bg-gray-100' : '' %>"
                data-sortable-target="item"
                data-rootein-id="<%= rootein.id %>"
                draggable="true"
                data-action="dragstart->sortable#dragstart dragend->sortable#dragend dragover->sortable#dragover drop->sortable#drop">
              <%= link_to rootein_path(rootein), class: "flex items-center gap-3 px-4 py-3 hover:bg-gray-50" do %>
                <span class="text-gray-400 cursor-grab opacity-0 group-hover:opacity-100 transition-opacity text-sm">≡</span>
                <%= streak_badge(rootein) %>
                <span class="flex-1">
                  <span class="font-medium text-sm <%= rootein == @rootein ? 'text-blue-600' : 'text-gray-800' %>"><%= rootein.name %></span>
                </span>
                <span class="text-gray-400 text-lg">›</span>
              <% end %>
              <div class="flex items-center justify-end gap-1 px-4 pb-2 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                <%= link_to "Edit", edit_rootein_path(rootein), class: "text-blue-500 hover:underline" %>
                <span class="text-gray-400">|</span>
                <%= button_to "Delete", rootein_path(rootein), method: :delete, class: "text-red-500 hover:underline cursor-pointer", data: { turbo_confirm: "Are you sure?" } %>
              </div>
            </li>
          <% end %>
        </ul>
      </div>
    </div>

    <!-- Main: calendar -->
    <div class="flex-1">
      <!-- Rootein name header -->
      <div class="<%= streak_color(@rootein) %> text-white text-center py-3 rounded-t-lg font-bold text-xl"><%= @rootein.name %></div>

      <!-- Calendar -->
      <div class="bg-black text-white rounded-b-lg p-6">
        <!-- Build calendar cells array -->
        <% first_day_wday = (@date.beginning_of_month.wday - 1) % 7 %>
        <% cells = [] %>
        <% first_day_wday.times { cells << nil } %>
        <% (@date.beginning_of_month..@date.end_of_month).each { |d| cells << d } %>
        <% overflow_start = @date.end_of_month + 1.day %>
        <% while cells.length % 7 != 0 %>
        <%   cells << overflow_start %>
        <%   overflow_start += 1.day %>
        <% end %>
        <% has_overflow = cells.last && cells.last.month != @date.month %>

        <!-- Month label -->
        <div class="text-center mb-3">
          <span class="font-bold text-xl">
            <%= @date.strftime("%b").upcase %><% if has_overflow %> - <%= @date.next_month.strftime("%b").upcase %><% end %>
          </span>
        </div>

        <!-- Day-of-week headers (outside the grid border) -->
        <div class="grid grid-cols-7 text-center mb-1">
          <% %w[M T W T F S S].each do |day_name| %>
            <div class="font-bold text-xl text-white py-1"><%= day_name %></div>
          <% end %>
        </div>

        <!-- Calendar grid -->
        <table class="w-full border-collapse border-2 border-gray-600">
          <tbody>
            <% cells.each_slice(7) do |week| %>
              <tr>
                <% week.each do |day| %>
                  <% if day.nil? %>
                    <td class="border border-gray-600 bg-white h-12"></td>
                  <% else %>
                    <% is_overflow = day.month != @date.month %>
                    <% is_today = day == Date.today %>
                    <% is_future = day > Date.today %>
                    <% completed = !is_overflow && @completions.include?(day) %>
                    <td class="border border-gray-600 text-center align-middle h-12 p-0 <%= completed ? 'bg-green-200' : 'bg-white' %>">
                      <% if completed %>
                        <% completion = @rootein.completions.find_by(completed_on: day) %>
                        <%= button_to rootein_completion_path(@rootein, completion), method: :delete,
                            form: { class: "w-full h-full" },
                            class: "w-full h-full cursor-pointer hover:bg-green-300 relative" do %>
                          <span class="text-green-800 text-xl"><%= day.day %></span>
                          <span class="absolute inset-0 flex items-center justify-center text-green-600 text-3xl font-bold">✓</span>
                        <% end %>
                      <% elsif is_overflow || is_future %>
                        <div class="py-1 text-xl <%= is_today ? 'text-red-500 font-bold' : 'text-gray-300' %>">
                          <%= day.day %>
                        </div>
                      <% else %>
                        <%= button_to rootein_completions_path(@rootein), params: { completed_on: day },
                            form: { class: "w-full h-full" },
                            class: "w-full h-full cursor-pointer hover:bg-gray-200 #{is_today ? 'text-red-500 font-bold' : 'text-gray-800'}" do %>
                          <span class="text-xl font-semibold"><%= day.day %></span>
                        <% end %>
                      <% end %>
                    </td>
                  <% end %>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>

        <!-- Prev / Next navigation (below the grid) -->
        <div class="flex items-center justify-between mt-3">
          <%= link_to "<< prev", rootein_path(@rootein, date: @date.prev_month), class: "text-gray-400 hover:text-white text-sm" %>
          <%= link_to "next >>", rootein_path(@rootein, date: @date.next_month), class: "text-gray-400 hover:text-white text-sm" %>
        </div>

        <!-- Motivational message -->
        <p class="text-center mt-3 text-sm italic
          <% if @rootein.current_streak == 0 %>text-red-400<% else %>text-green-400<% end %>">
          <% if @rootein.current_streak == 0 %>
            How about getting started on this Rootein already!
          <% elsif @rootein.current_streak < 7 %>
            You have been doing this Rootein for <%= @rootein.current_streak %> days
          <% elsif @rootein.current_streak < 21 %>
            You're building a real habit. Stay consistent!
          <% else %>
            This is a Rootein now. You own it!
          <% end %>
        </p>
      </div>
    </div>
  </div>
</div>
